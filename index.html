<!DOCTYPE html>
<html>
<head>
    <title>AR Street Art - V 26 Markerless</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-family: sans-serif;
            z-index: 10;
        }
        #version {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-family: sans-serif;
            font-size: 12px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="status">Initializing AR... Please ensure you are on HTTPS.</div>
    <div id="version">HTML Version: 26 Markerless</div>

    <a-scene
        webxr="requiredFeatures: immersive-ar, hit-test; overlayElement: #status;"
        renderer="antialias: true; logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true"
        vr-mode-ui="enabled: false"
        ar-placement-component
    >
        <a-assets timeout="30000">
            <a-asset-item id="GREED" src="https://raw.githubusercontent.com/forevermidicom/GREED/main/GREED.glb" crossorigin="anonymous"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls></a-camera>

        <a-entity id="model-container" visible="false"></a-entity>

    </a-scene>

    <script>
        AFRAME.registerComponent('ar-placement-component', {
            init: function () {
                const scene = this.el;
                const modelContainer = document.querySelector('#model-container');
                const statusDisplay = document.querySelector('#status');
                const modelAsset = document.querySelector('#GREED');

                let placed = false;
                let hitTestSource = null;
                let referenceSpace = null;

                statusDisplay.innerText = 'Tap the "AR" button below to start. (Requires HTTPS)';

                scene.addEventListener('loaded', () => {
                    console.log('A-Frame scene loaded.');
                });

                scene.addEventListener('enter-vr', async () => {
                    if (scene.is('ar-mode')) {
                        console.log('Entered AR mode. Attempting WebXR session.');
                        statusDisplay.innerText = 'Scanning environment... Move your device to detect a surface.';

                        try {
                            const xrSession = scene.renderer.xr.getSession();
                            referenceSpace = await xrSession.requestReferenceSpace('viewer');
                            hitTestSource = await xrSession.requestHitTestSource({ space: referenceSpace });

                            xrSession.requestAnimationFrame(this.tick);
                            console.log('WebXR hit test source ready.');
                            statusDisplay.innerText = 'Move your device to scan for a surface. Tap to place model.';
                        } catch (error) {
                            console.error('Failed to start WebXR hit test:', error);
                            statusDisplay.innerText = `AR error: ${error.message}. Ensure device supports WebXR AR.`;
                        }
                    }
                });

                scene.addEventListener('exit-vr', () => {
                    statusDisplay.innerText = 'Exited AR. Reload page to restart.';
                    placed = false;
                    modelContainer.setAttribute('visible', false);
                    if (hitTestSource) {
                        hitTestSource.cancel();
                        hitTestSource = null;
                    }
                    console.log('Exited AR mode.');
                });

                const reticle = document.createElement('a-entity');
                reticle.setAttribute('geometry', { primitive: 'ring', radiusOuter: 0.1, radiusInner: 0.07 });
                reticle.setAttribute('material', { color: 'white', shader: 'flat', opacity: 0.5, transparent: true });
                reticle.setAttribute('rotation', '-90 0 0');
                reticle.setAttribute('visible', 'false');
                scene.appendChild(reticle);

                this.tick = (time, frame) => {
                    if (!placed && hitTestSource && referenceSpace) {
                        const hitTestResults = frame.getHitTestResults(hitTestSource);

                        if (hitTestResults.length > 0) {
                            const hitPose = hitTestResults[0].getPose(referenceSpace);
                            reticle.setAttribute('position', hitPose.transform.position);
                            reticle.setAttribute('visible', true);
                            statusDisplay.innerText = 'Surface detected. Tap to place model.';
                        } else {
                            reticle.setAttribute('visible', false);
                            statusDisplay.innerText = 'No surface detected. Keep scanning.';
                        }
                    } else if (placed) {
                        reticle.setAttribute('visible', false);
                    }
                    if (scene.renderer.xr.getSession()) {
                        scene.renderer.xr.getSession().requestAnimationFrame(this.tick);
                    }
                };

                scene.addEventListener('click', (event) => {
                    if (!placed && reticle.getAttribute('visible')) {
                        modelContainer.setAttribute('position', reticle.getAttribute('position'));
                        modelContainer.setAttribute('gltf-model', '#GREED');
                        modelContainer.setAttribute('scale', '10 10 10');
                        modelContainer.setAttribute('rotation', '0 0 0');
                        modelContainer.setAttribute('visible', true);

                        placed = true;
                        statusDisplay.innerText = 'Model placed. Move around to view.';
                        console.log('Model placed at:', modelContainer.object3D.position);

                        if (hitTestSource) {
                            hitTestSource.cancel();
                            hitTestSource = null;
                        }
                    } else if (!placed && !reticle.getAttribute('visible')) {
                        statusDisplay.innerText = 'No surface detected. Keep scanning.';
                    }
                });

                modelAsset.addEventListener('model-error', (e) => {
                    console.error('Model Load Error:', e);
                    statusDisplay.innerText = 'Error loading 3D model. Check console for details.';
                });
                modelAsset.addEventListener('loaded', () => {
                    console.log('GREED model asset loaded successfully');
                });
            }
        });
    </script>
</body>
</html>
